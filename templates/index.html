<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Invoice Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background: #f6f8fa; }
    .card { border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
    .form-label { font-weight: 600; }
    .small-muted { font-size: 0.85rem; color: #6c757d; }
    .invoice-list td, .invoice-list th { vertical-align: middle; }
    .file-name { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size: 0.85rem; color: #495057; }
  </style>
</head>
<body>
<div class="container py-5">

  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card p-4">
        <h4 class="mb-3">Generate Invoice</h4>
        <form id="invoice-form" action="/generate" method="POST">
          <div class="mb-3">
            <label class="form-label">Enter Bill Amount</label>
            <input type="number" step="0.01" name="y_value" class="form-control" required>
            <div class="small-muted">Enter the base Bill amount the system will apply +2% and round up.</div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Select Date</label>
              <div class="input-group">
                <input type="date" name="date" id="date-input" class="form-control" value="{{ default_date }}" required>
                <button type="button" id="today-btn" class="btn btn-outline-secondary" title="Set to today">Today</button>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Invoice Number Suffix</label>
              <input type="text" name="invoice_suffix" id="invoice-suffix" class="form-control" value="{{ suggested_suffix }}" required>
              <div class="small-muted">Automatically suggested based on existing invoices for the selected month.</div>
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-md-6">
              <label class="form-label">Payment Type</label>
              <select name="payment_type" class="form-select" required>
                <option value="Cash">Cash</option>
                <option value="Cheque">Cheque</option>
                <option value="UPI">UPI</option>
                <option value="Bank Transfer">Bank Transfer</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">HSN Code</label>
              <input type="text" name="hsn_code" class="form-control" required>
            </div>
          </div>

          <div class="mt-3 d-flex gap-2">
            <button type="submit" class="btn btn-primary">Generate & Download PDF</button>
            <button type="reset" class="btn btn-outline-secondary">Reset</button>
          </div>
        </form>

        <hr class="my-4">

        <div>
          <h6 class="mb-2">Tip</h6>
          <div class="small-muted">If you change the date, the invoice suffix suggestion will update automatically.</div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card p-4">
        <h5 class="mb-3">Previously Generated Invoices</h5>

        {% if invoices %}
          <div class="table-responsive">
            <table class="table table-sm table-hover invoice-list">
              <thead>
                <tr>
                  <th>Invoice No</th>
                  <th>File</th>
                  <th class="text-end">Action</th>
                </tr>
              </thead>
              <tbody>
                {% for inv in invoices %}
                  <tr>
                    <td>{{ inv.invoice_no }}</td>
                    <td>
                      <div>{{ inv.display_name }}</div>
                      <div class="file-name">{{ inv.filename }}</div>
                    </td>
                    <td class="text-end">
                      <a class="btn btn-sm btn-outline-primary" href="{{ inv.url }}">Download</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="small-muted">No invoices found in the output folder yet.</div>
        {% endif %}

        <hr class="my-3">
        <div class="small-muted">Note: PDFs are stored with safe filenames (underscores). The browser download will suggest the friendly name (with spaces).</div>
      </div>
    </div>
  </div>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const dateInput = document.getElementById('date-input');
  const suffixInput = document.getElementById('invoice-suffix');
  const todayBtn = document.getElementById('today-btn');

  async function updateSuffixForDate(dateVal){
    if (!dateVal) return;
    try {
      const resp = await fetch(`/next-suffix?date=${encodeURIComponent(dateVal)}`);
      if (!resp.ok) return;
      const payload = await resp.json();
      if (payload.next_suffix) {
        suffixInput.value = payload.next_suffix;
      }
    } catch (e) {
      console.error("Failed to fetch suffix", e);
    }
  }

  dateInput.addEventListener('change', (e) => {
    updateSuffixForDate(e.target.value);
  });

  todayBtn.addEventListener('click', () => {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const iso = `${yyyy}-${mm}-${dd}`;
    dateInput.value = iso;
    updateSuffixForDate(iso);
  });

  document.addEventListener('DOMContentLoaded', () => {
    updateSuffixForDate(dateInput.value);
  });
</script>
</body>
</html>
